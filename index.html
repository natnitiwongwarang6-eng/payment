<!DOCTYPE html>
<html lang="lo">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Natniti Store</title>
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Lao:wght@400;500;600;700&display=swap');
body { 
  font-family: 'Noto Sans Lao', sans-serif; 
  width: 100%;
  height: auto;
  min-height: 100vh;
}
.print-area { background: white !important; }
@media print {
  body * { visibility: hidden; }
  .print-area, .print-area * { visibility: visible; }
  .print-area { position: absolute; left: 0; top: 0; width: 100%; }
  .no-print { display: none !important; }
}
</style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect } = React;


// ລະຫັດ (SHA-256)
const encryptPassword = async (password) => {
  const encoder = new TextEncoder();
  const data = encoder.encode(password);
  const hash = await crypto.subtle.digest('SHA-256', data);
  return Array.from(new Uint8Array(hash))
    .map(b => b.toString(16).padStart(2, '0'))
    .join('');
};

// ລະຫັດ
const HASHED_PASSWORD = 'a745d6148f2aca1dd8440e1c45482dc7f3ed14a7749ff1ad7e6fbf160608ecac'; // hash ของ "1234"

// ບ່ອນຕັ້ງຄ່າບັນຊີ
const ACCOUNTS = [
  {
    logo : 'bank.webp',
    accountName: 'ຄິດທະພອນ ພູມມະໄຊທອງ ຫລື ອາດຈະເປັນ OneCash...', // สมชาย ใจดี
    bankLogo: 'unnamed.png',
    bankName: 'ການຄ້າ (BCEL One)',
    accountNumber: 'ເລກບັນຊີ : 0101237636072'
  },
  {
    logo: 'bank.webp',
    accountName: 'ສົມພັນ ວັນນະວົງ',
    bankLogo: 'OIP.webp',
    bankName: 'ຢູມັນນີ້ (Umoney)',
    accountNumber: '* ໂຕຄິວອາ '
  }
];


// ฟังก์ชันแปลงข้อมูลเป็น base64 (สำหรับสร้างลิงก์)
const encodeData = (data) => {
  const json = JSON.stringify(data);
  const bytes = new TextEncoder().encode(json);
  let binary = '';
  for (let i = 0; i < bytes.length; i++) binary += String.fromCharCode(bytes[i]);
  return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
};

// ฟังก์ชันถอดรหัส base64 กลับเป็นข้อมูลเดิม
const decodeData = (encodedData) => {
  try {
    let base64 = encodedData.replace(/-/g, '+').replace(/_/g, '/');
    const pad = base64.length % 4;
    if (pad) base64 += '===='.slice(pad);
    const binary = atob(base64);
    const bytes = new Uint8Array(binary.length);
    for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
    const json = new TextDecoder().decode(bytes);
    return JSON.parse(json);
  } catch { return null; }
};

const formatPrice = (price) => new Intl.NumberFormat('en-US').format(price);


// สร้างเลขที่ใบสั่งแบบสุ่ม
const generateOrderNumber = () => {
  const randomNum = Math.floor(Math.random() * 90000) + 10000; // สุ่มเลข 5 หลัก
  return `Natniti${randomNum}`;
};

// Order Form
const OrderForm = ({ items, setItems, orderNumber, generateNewOrderNumber }) => {
  const [itemName, setItemName] = useState('');
  const [quantity, setQuantity] = useState('');
  const [price, setPrice] = useState('');
  const [showSuggestions, setShowSuggestions] = useState(false);
  const [showQuantityModal, setShowQuantityModal] = useState(false);
  const [selectedProduct, setSelectedProduct] = useState(null);
  const [modalQuantity, setModalQuantity] = useState('1');
  const [showProductManager, setShowProductManager] = useState(false);
  const [newProductName, setNewProductName] = useState('');
  const [newProductPrice, setNewProductPrice] = useState('');
  const [editingProduct, setEditingProduct] = useState(null);
  const [showDeleteModal, setShowDeleteModal] = useState(false);
  const [productToDelete, setProductToDelete] = useState(null);

  // Load products from localStorage or use defaults
  const getStoredProducts = () => {
    const stored = localStorage.getItem('quickProducts');
    if (stored) {
      return JSON.parse(stored);
    }
    return [
    
    ];
  };

  const [predefinedProducts, setPredefinedProducts] = useState(getStoredProducts);


  // ฟังก์ชันบันทึกสินค้าลง localStorage
  const saveProducts = (products) => {
    localStorage.setItem('quickProducts', JSON.stringify(products));
    setPredefinedProducts(products);
  };

  // Add new product
  const addNewProduct = () => {
    if (newProductName && newProductPrice) {
      const newProduct = {
        id: Date.now(),
        name: newProductName,
        price: parseFloat(newProductPrice)
      };
      const updatedProducts = [...predefinedProducts, newProduct];
      saveProducts(updatedProducts);
      setNewProductName('');
      setNewProductPrice('');
    }
  };

  // Edit product
  const startEditProduct = (product) => {
    setEditingProduct(product);
    setNewProductName(product.name);
    setNewProductPrice(product.price.toString());
  };

  const saveEditProduct = () => {
    if (editingProduct && newProductName && newProductPrice) {
      const updatedProducts = predefinedProducts.map(p => 
        p.id === editingProduct.id 
          ? { ...p, name: newProductName, price: parseFloat(newProductPrice) }
          : p
      );
      saveProducts(updatedProducts);
      setEditingProduct(null);
      setNewProductName('');
      setNewProductPrice('');
    }
  };

  const cancelEdit = () => {
    setEditingProduct(null);
    setNewProductName('');
    setNewProductPrice('');
  };

  // Delete product
  const deleteProduct = (product) => {
    setProductToDelete(product);
    setShowDeleteModal(true);
  };

  const confirmDelete = () => {
    if (productToDelete) {
      const updatedProducts = predefinedProducts.filter(p => p.id !== productToDelete.id);
      saveProducts(updatedProducts);
      setShowDeleteModal(false);
      setProductToDelete(null);
    }
  };

  const cancelDelete = () => {
    setShowDeleteModal(false);
    setProductToDelete(null);
  };

  const addItem = () => {
    if(itemName && quantity && price){
      setItems([...items, { 
        id: Date.now(), 
        name: itemName, 
        quantity: parseInt(quantity), 
        price: parseFloat(price) 
      }]);
      setItemName(''); setQuantity(''); setPrice('');
    }
  };

  const addPredefinedItem = (product) => {
    setSelectedProduct(product);
    setShowQuantityModal(true);
    setShowSuggestions(false);
  };

  const confirmAddItem = () => {
    if (selectedProduct && modalQuantity) {
      setItems([...items, {
        id: Date.now(),
        name: selectedProduct.name,
        quantity: parseInt(modalQuantity),
        price: selectedProduct.price
      }]);
      setShowQuantityModal(false);
      setSelectedProduct(null);
      setModalQuantity('1');
    }
  };

  const removeItem = (id) => {
    setItems(items.filter(item => item.id !== id));
  };

  const filteredProducts = predefinedProducts.filter(product =>
    product.name.toLowerCase().includes(itemName.toLowerCase())
  );

  return (
    <div className="bg-white p-6 rounded-lg shadow-lg">
      <div className="flex justify-between items-center mb-6">
        <h2 className="text-2xl font-bold text-gray-800">ສ້າງໃບສັ່ງຊື້</h2>
        <div className="text-right">
          <p className="text-sm text-gray-600">ເລກທີໃບສັ່ງ</p>
          <p className="text-xl font-bold text-blue-600">#{orderNumber}</p>
          <button
            onClick={generateNewOrderNumber}
            className="text-xs text-blue-500 hover:text-blue-700 underline mt-1"
          >
            ສ້າງເລກໃໝ່
          </button>
        </div>
      </div>

      {/* Add Items */}
      <div className="mb-6 space-y-4">
        <h3 className="text-lg font-semibold text-gray-700">ເພີ່ມສິນຄ້າ</h3>
        
        {/* Quick Add Buttons */}
        <div className="mb-4 flex gap-2 flex-wrap">
          <button
            onClick={() => setShowSuggestions(!showSuggestions)}
            className="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors"
          >
            {showSuggestions ? 'ປິດລາຍການສິນຄ້າ' : 'ເລືອກສິນຄ້າທີ່ກຳນົດໄວ້'}
          </button>
          <button
            onClick={() => setShowProductManager(!showProductManager)}
            className="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition-colors"
          >
            {showProductManager ? 'ປິດການຈັດການສິນຄ້າ' : 'ຈັດການສິນຄ້າທີ່ກຳນົດໄວ້'}
          </button>
        </div>

        {/* Product Manager */}
        {showProductManager && (
          <div className="bg-gray-50 p-4 rounded-lg mb-4">
            <h4 className="font-semibold text-gray-700 mb-3">ຈັດການສິນຄ້າທີ່ກຳນົດໄວ້</h4>
            
            {/* Add/Edit Product Form */}
            <div className="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-4">
              <input
                type="text"
                placeholder="ຊື່ສິນຄ້າ"
                value={newProductName}
                onChange={(e) => setNewProductName(e.target.value)}
                className="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
              <input
                type="number"
                placeholder="ລາຄາ (ກີບ)"
                value={newProductPrice}
                onChange={(e) => setNewProductPrice(e.target.value)}
                className="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
              <div className="flex gap-2">
                {editingProduct ? (
                  <>
                    <button
                      onClick={saveEditProduct}
                      className="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors flex-1"
                    >
                      ບັນທຶກ
                    </button>
                    <button
                      onClick={cancelEdit}
                      className="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors"
                    >
                      ຍົກເລີກ
                    </button>
                  </>
                ) : (
                  <button
                    onClick={addNewProduct}
                    className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors flex-1"
                  >
                    ເພີ່ມສິນຄ້າ
                  </button>
                )}
              </div>
            </div>

            {/* Products List */}
            <div className="space-y-2 max-h-60 overflow-y-auto">
              {predefinedProducts.map((product) => (
                <div key={product.id} className="flex justify-between items-center bg-white p-3 rounded-lg border">
                  <div>
                    <span className="font-medium">{product.name}</span>
                    <span className="text-gray-600 ml-2">{formatPrice(product.price)} ກີບ</span>
                  </div>
                  <div className="flex gap-2">
                    <button
                      onClick={() => startEditProduct(product)}
                      className="text-blue-500 hover:text-blue-700 text-sm px-2 py-1 rounded transition-colors"
                    >
                      ແກ້ໄຂ
                    </button>
                    <button
                      onClick={() => deleteProduct(product)}
                      className="text-red-500 hover:text-red-700 text-sm px-2 py-1 rounded transition-colors"
                    >
                      ລຶບ
                    </button>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}

        {showSuggestions && (
          <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2 mb-4">
            {predefinedProducts.map((product) => (
              <button
                key={product.id}
                onClick={() => addPredefinedItem(product)}
                className="bg-blue-100 hover:bg-blue-200 text-blue-800 px-3 py-2 rounded-lg text-sm transition-colors"
              >
                {product.name}<br/>
                <span className="text-xs">{formatPrice(product.price)} ກີບ</span>
              </button>
            ))}
          </div>
        )}

        {/* Manual Add Form */}
        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
          <div className="relative">
            <input
              type="text"
              placeholder="ຊື່ສິນຄ້າ"
              value={itemName}
              onChange={(e) => {
                setItemName(e.target.value);
                setShowSuggestions(false);
              }}
              className="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
            {itemName && filteredProducts.length > 0 && (
              <div className="absolute z-10 w-full bg-white border border-gray-300 rounded-lg mt-1 max-h-40 overflow-y-auto">
                {filteredProducts.map((product, index) => (
                  <button
                    key={index}
                    onClick={() => {
                      setItemName(product.name);
                      setPrice(product.price);
                    }}
                    className="w-full text-left px-4 py-2 hover:bg-gray-100 flex justify-between"
                  >
                    <span>{product.name}</span>
                    <span className="text-gray-500">{formatPrice(product.price)} ກີບ</span>
                  </button>
                ))}
              </div>
            )}
          </div>
          <input
            type="number"
            placeholder="ຈຳນວນ"
            value={quantity}
            onChange={(e) => setQuantity(e.target.value)}
            className="border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
          <input
            type="number"
            placeholder="ລາຄາ (ກີບ)"
            value={price}
            onChange={(e) => setPrice(e.target.value)}
            className="border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
          <button
            onClick={addItem}
            className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors"
          >
            ເພີ່ມ
          </button>
        </div>
      </div>

      {/* Items List */}
      {items.length > 0 && (
        <div className="mb-6">
          <h3 className="text-lg font-semibold text-gray-700 mb-4">ລາຍການສິນຄ້າ</h3>
          <div className="space-y-2">
            {items.map((item) => (
              <div key={item.id} className="flex justify-between items-center bg-gray-50 p-3 rounded-lg">
                <div>
                  <span className="font-medium">{item.name}</span>
                  <span className="text-gray-600 ml-2">x{item.quantity}</span>
                </div>
                <div className="flex items-center space-x-3">
                  <span className="font-semibold">{formatPrice(item.price * item.quantity)} ກີບ</span>
                  <button
                    onClick={() => removeItem(item.id)}
                    className="text-red-500 hover:text-red-700 transition-colors"
                  >
                    ✕
                  </button>
                </div>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* Quantity Modal */}
      {showQuantityModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white p-6 rounded-lg shadow-xl">
            <h3 className="text-lg font-semibold mb-4">ເລືອກຈຳນວນ: {selectedProduct?.name}</h3>
            <div className="mb-4">
              <input
                type="number"
                value={modalQuantity}
                onChange={(e) => setModalQuantity(e.target.value)}
                className="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                min="1"
              />
            </div>
            <div className="flex space-x-3">
              <button
                onClick={confirmAddItem}
                className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors"
              >
                ເພີ່ມ
              </button>
              <button
                onClick={() => setShowQuantityModal(false)}
                className="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors"
              >
                ຍົກເລີກ
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Delete Confirmation Modal */}
      {showDeleteModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white p-6 rounded-lg shadow-xl max-w-sm mx-4">
            <div className="text-center">
              <div className="w-16 h-16 mx-auto mb-4 rounded-full bg-red-100 flex items-center justify-center">
                <span className="text-2xl text-red-600">⚠️</span>
              </div>
              <h3 className="text-lg font-semibold mb-2 text-gray-800">ຢືນຢັນການລຶບ</h3>
              <p className="text-gray-600 mb-6">
                ຕ້ອງການລຶບສິນຄ້າ "<span className="font-semibold">{productToDelete?.name}</span>" ແທ້ບໍ?
              </p>
              <div className="flex space-x-3 justify-center">
                <button
                  onClick={confirmDelete}
                  className="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg transition-colors"
                >
                  ລຶບ
                </button>
                <button
                  onClick={cancelDelete}
                  className="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition-colors"
                >
                  ຍົກເລີກ
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

// ส่วนแสดงใบเสร็จ
const OrderCard = ({ items, orderNumber }) => {
  const total = items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
  const currentDate = new Date().toLocaleDateString('lo-LA');
  const currentTime = new Date().toLocaleTimeString('lo-LA', { hour: '2-digit', minute: '2-digit' });
  const [qrError, setQrError] = useState(false);

  return (
    <div className="print-area bg-white p-6 rounded-lg shadow-lg max-w-sm mx-auto border-2 border-red-200">
      {/* Header */}
      <div className="text-center mb-4 border-b-2 border-dashed border-gray-300 pb-4">
        <h1 className="text-xl font-bold text-gray-800 mb-1">ຊ່ອງທາງການຊຳລະເງິນ / PAYMENT METHOD</h1>
        <div className="text-sm text-gray-600">
          <p>Natniti Store</p>
        </div>
      </div>

      {/* QR Code Section */}
      <div className="text-center mb-4">
        <div className="bg-white p-3 rounded-lg border-2 border-dashed border-red-400 mb-3">
          <p className="text-sm text-gray-600">ຫລັງຈາກໂອນແລ້ວໃຫ້ແຈ້ງບິນການໂອນທຸກຮອບ</p>
          {/* Show QR image; if it fails, show a helpful fallback message */}
          {!qrError ? (
            <img
              src="qr.png"
              alt="QR Code"
              onError={() => setQrError(true)}
              className="mx-auto mt-2 w-48 h-48 object-contain"
            />
          ) : (
            <div className="text-xs text-red-500 mt-2">
              รูป QR ไม่แสดง: กรุณาวางไฟล์ <span className="font-semibold">qr.png</span> ในโฟลเดอร์เดียวกัน หรือแก้ไขตัวแปร <code>FIXED_QR_CODE</code> ให้เป็น URL/พาธที่ถูกต้อง
            </div>
          )}
          {/* Account info under QR (read-only, set in code) */}
          <div className="mt-3 space-y-2">
              {ACCOUNTS.map((acc, idx) => (
                <div key={idx} className="p-2 bg-gray-50 rounded text-sm text-gray-800 border border-red-200">
                  <div className="flex items-center gap-2">
                    <img src='bank.webp' alt="acc logo" className="w-6 h-6" />
                    <span className="font-bold">{acc.accountName}</span>
                    <span className="text-xs text-gray-500">/</span>
                    <img src={acc.bankLogo} alt="bank logo" className="w-6 h-6" />
                    <span className="text-sm">{acc.bankName}</span>
                  </div>
                  <div className="text-1xl text-dark-700 mt-1">{acc.accountNumber}</div>
                </div>
              ))}
            </div>
        </div>
      </div>

      {/* Order Number */}
      <div className="text-center mb-4">
        <div className="bg-gray-100 rounded-lg p-3 border-2 border-dashed border-red-400">
          <p className="text-sm font-medium text-gray-600 mb-1">ຫມາຍເລກ</p>
          <p className="text-2xl font-bold text-red-600">#{orderNumber}</p>
        </div>
      </div>

      {/* Items Table */}
      <div className="mb-4">
        <div className="border-b-2 border-gray-300 pb-2 mb-3">
          <div className="grid grid-cols-12 gap-1 text-xs font-semibold text-gray-700">
            <div className="col-span-6">ລາຍການ</div>
            <div className="col-span-2 text-center">ຈຳນວນ</div>
            <div className="col-span-2 text-right">ລາຄາ</div>
            <div className="col-span-2 text-right">ລວມ</div>
          </div>
        </div>
        
        {items.length === 0 ? (
          <p className="text-gray-500 text-center py-4 text-sm">ບໍ່ມີສິນຄ້າ</p>
        ) : (
          <div className="space-y-2">
            {items.map((item, index) => (
              <div key={item.id} className="grid grid-cols-12 gap-1 text-sm py-1 border-b border-gray-200">
                <div className="col-span-6">
                  <span className="font-medium">{item.name}</span>
                </div>
                <div className="col-span-2 text-center">{item.quantity}</div>
                <div className="col-span-2 text-right">{formatPrice(item.price)}</div>
                <div className="col-span-2 text-right font-semibold">{formatPrice(item.price * item.quantity)}</div>
              </div>
            ))}
          </div>
        )}
      </div>

      {/* Total Section */}
      {items.length > 0 && (
        <div className="border-t-2 border-dashed border-gray-300 pt-3">
          <div className="flex justify-between items-center mb-2">
          
          </div>
          <div className="flex justify-between items-center text-lg font-bold bg-gray-100 p-2 rounded">
            <span>ລວມທັງໝົດ:</span>
            <span className="text-blue-600">{formatPrice(total)} ກີບ</span>
          </div>
        </div>
      )}

      {/* Footer */}


      <div className="mt-4 text-center border-t-2 border-dashed border-gray-300 pt-3">
        <p className="text-xs text-gray-500 mb-2">ຂອບໃຈທີ່ໃຊ້ບໍລິການ</p>
        <div className="text-xs text-gray-400">
          <p>*** Natniti Store ***</p>
        </div>
      </div>
    </div>
  );
};

// ส่วนหลักของแอป
const App = () => {
  const [items, setItems] = useState([]);
  const [activeTab, setActiveTab] = useState('form');
  const [orderNumber, setOrderNumber] = useState(() => generateOrderNumber());
  const [isLoggedIn, setIsLoggedIn] = useState(false);
  const [showLoginModal, setShowLoginModal] = useState(true);

  // ตรวจสอบสถานะการ login เมื่อโหลดหน้า
  useEffect(() => {
    const checkLoginStatus = async () => {
      const storedLoginStatus = localStorage.getItem('isLoggedIn');
      const storedLoginHash = localStorage.getItem('loginHash');
      
      if (storedLoginStatus === 'true' && storedLoginHash) {
        // ตรวจสอบว่า login ไม่เกิน 24 ชั่วโมง
        const currentTime = Date.now();
        const loginTime = parseInt(storedLoginHash, 16);
        const hoursSinceLogin = (currentTime - loginTime) / (1000 * 60 * 60);
        
        if (hoursSinceLogin < 24) {
          setIsLoggedIn(true);
          setShowLoginModal(false);
        } else {
          // ถ้าเกิน 24 ชั่วโมง ให้ logout
          localStorage.removeItem('isLoggedIn');
          localStorage.removeItem('loginHash');
          setIsLoggedIn(false);
          setShowLoginModal(true);
        }
      } else {
        setIsLoggedIn(false);
        setShowLoginModal(!isViewOnly); // แสดง login modal เฉพาะเมื่อไม่ใช่โหมดดูอย่างเดียว
      }
    };
    
    checkLoginStatus();
  }, [isViewOnly]);
  const [isViewOnly, setIsViewOnly] = useState(false);
  
  const handleLogin = async (password) => {
    try {
      // เข้ารหัส password ที่ผู้ใช้ป้อน
      const hashedInput = await encryptPassword(password);
      
      // เปรียบเทียบกับ password ที่เข้ารหัสไว้
      if (hashedInput === HASHED_PASSWORD) {
        setIsLoggedIn(true);
        setShowLoginModal(false);
        localStorage.setItem('isLoggedIn', 'true');
        
        // เพิ่มการเข้ารหัสเวลาที่ login สำเร็จ
        const loginTime = Date.now();
        const encryptedTime = await encryptPassword(loginTime.toString());
        localStorage.setItem('loginHash', encryptedTime);
      } else {
        alert('รหัสผ่านไม่ถูกต้อง');
      }
    } catch (error) {
      console.error('เกิดข้อผิดพลาดในการเข้าสู่ระบบ:', error);
      alert('เกิดข้อผิดพลาดในการเข้าสู่ระบบ กรุณาลองใหม่อีกครั้ง');
    }
  };

  const generateNewOrderNumber = () => {
    setOrderNumber(generateOrderNumber());
  };

  // Load data from URL on mount
  useEffect(() => {
    const urlParams = new URLSearchParams(window.location.search);
    const data = urlParams.get('data');
    const viewMode = urlParams.get('view');
    
    if (data) {
      const decoded = decodeData(data);
      if (decoded) {
        setItems(decoded.items || []);
        setOrderNumber(decoded.orderNumber || generateOrderNumber());
        setActiveTab('card');
        
        // If view=true, set to view-only mode
        if (viewMode === 'true') {
          setIsViewOnly(true);
          setShowLoginModal(false); // Don't show login modal in view-only mode
        }
      }
    }
  }, []);

  const [showModal, setShowModal] = useState(false);
  const [modalMessage, setModalMessage] = useState('');
  const [modalType, setModalType] = useState('success');

  const generateShareableLink = async () => {
    const data = { items, orderNumber };
    const encoded = encodeData(data);
    const url = `${window.location.origin}${window.location.pathname}?data=${encoded}&view=true`;
    let copied = false;
    // Try clipboard API
    if (navigator.clipboard && window.isSecureContext) {
      try {
        await navigator.clipboard.writeText(url);
        copied = true;
      } catch (e) {
        copied = false;
      }
    }
    // Fallback for insecure context or error
    if (!copied) {
      try {
        const tempInput = document.createElement('input');
        tempInput.value = url;
        document.body.appendChild(tempInput);
        tempInput.select();
        tempInput.setSelectionRange(0, 99999); // For mobile
        document.execCommand('copy');
        document.body.removeChild(tempInput);
        copied = true;
      } catch (e) {
        copied = false;
      }
    }
    if (copied) {
      setModalMessage('ລິ້ງໄດ້ຖືກຄັດລອກແລ້ວ!');
      setModalType('success');
    } else {
      setModalMessage('ຄັດລອກລິ້ງບໍ່ສຳເລັດ กรุณาคัดลอกเอง: ' + url);
      setModalType('error');
    }
    setShowModal(true);
  };

  const shareImage = async () => {
    const element = document.querySelector('.print-area');
    if (element) {
      // Create a clone of the element to modify
      const tempElement = element.cloneNode(true);
      
      // Remove any unnecessary elements from the clone
      const qrSection = tempElement.querySelector('.bg-white.p-3.rounded-lg.border-2.border-dashed.border-red-400.mb-3');
      if (qrSection) {
        qrSection.remove();
      }
      
      // Add the temp element to the document (hidden)
      tempElement.style.position = 'absolute';
      tempElement.style.left = '-9999px';
      document.body.appendChild(tempElement);
      
      const canvas = await html2canvas(tempElement, {
        backgroundColor: '#ffffff',
        scale: 2
      });
      
      // Remove the temp element
      document.body.removeChild(tempElement);
      
      // Convert canvas to blob
      canvas.toBlob(async (blob) => {
        if (navigator.share && navigator.canShare) {
          const file = new File([blob], `receipt-${orderNumber}.png`, { type: 'image/png' });
          
          if (navigator.canShare({ files: [file] })) {
            try {
              await navigator.share({
                title: `Payment method #${orderNumber}`,
                text: 'ຫລັງຈາກໂອນແລ້ວສົ່ງລິ້ງເລີຍເດີ ສາມາດໂອນໄດ້ທຸກທະນາຄານຖ້າຫາກໂອນຜິດໂອນເກິນ ໂອນຄືນເຮົາຈະຫັກ 50% ທຸກກໍລະນີ ແລະ ໂອນກັບບັນຊີທີ່ໂອນມາ/ຕົ້ນທາງເທົ່ານັ້ນ',
                files: [file]
              });
              setModalMessage('ແຊຣ์ຮູບສຳເລັດແລ້ວ!');
              setModalType('success');
              setShowModal(true);
            } catch (error) {
              if (error.name !== 'AbortError') {
                // Fallback to download
                const link = document.createElement('a');
                link.download = `receipt-${orderNumber}.png`;
                link.href = canvas.toDataURL();
                link.click();
                setModalMessage('ດາວໂຫລດຮູບສຳເລັດແລ້ວ!');
                setModalType('success');
                setShowModal(true);
              }
            }
          } else {
            // Fallback to download
            const link = document.createElement('a');
            link.download = `receipt-${orderNumber}.png`;
            link.href = canvas.toDataURL();
            link.click();
            setModalMessage('ດາວໂຫລດຮູບສຳເລັດແລ້ວ!');
            setModalType('success');
            setShowModal(true);
          }
        } else {
          // Fallback to download
          const link = document.createElement('a');
          link.download = `receipt-${orderNumber}.png`;
          link.href = canvas.toDataURL();
          link.click();
          setModalMessage('ດາວໂຫລດຮູບສຳເລັດແລ້ວ!');
          setModalType('success');
          setShowModal(true);
        }
      }, 'image/png');
    }
  };

  const printCard = () => {
    window.print();
  };

  // กล่องกรอก password สำหรับเข้าสู่ระบบ
  const LoginModal = ({ onLogin }) => {
  const [password, setPassword] = useState('');

  const handleSubmit = (e) => {
    e.preventDefault();
    onLogin(password);
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white p-8 rounded-lg shadow-xl max-w-sm mx-4 w-full">
        <div className="text-center">
          <h2 className="text-2xl font-bold mb-4">เข้าสู่ระบบ</h2>
          <form onSubmit={handleSubmit}>
            <input
              type="password"
              placeholder="กรุณาใส่รหัสผ่าน"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              className="w-full border border-gray-300 rounded-lg px-4 py-2 mb-4 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
            <button
              type="submit"
              className="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors"
            >
              เข้าสู่ระบบ
            </button>
          </form>
        </div>
      </div>
    </div>
  );
};

return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 py-8">
      {showLoginModal && <LoginModal onLogin={handleLogin} />}
      <div className="container mx-auto px-4 max-w-full">
        <div className="text-center mb-8">
          <h1 className="text-4xl font-bold text-gray-800 mb-2">Natniti Store</h1>
          <p className="text-gray-600">Payments</p>
        </div>

        {/* Tab Navigation - Hide in view-only mode */}
        {!isViewOnly && (
          <div className="flex justify-center mb-8 no-print">
            <div className="bg-white rounded-lg p-1 shadow-lg">
              <button
                onClick={() => setActiveTab('form')}
                className={`px-6 py-2 rounded-md transition-colors ${
                  activeTab === 'form' 
                    ? 'bg-blue-500 text-white' 
                    : 'text-gray-600 hover:text-blue-500'
                }`}
              >
                ຕັ້ງຄ່າ
              </button>
              <button
                onClick={() => setActiveTab('card')}
                className={`px-6 py-2 rounded-md transition-colors ${
                  activeTab === 'card' 
                    ? 'bg-blue-500 text-white' 
                    : 'text-gray-600 hover:text-blue-500'
                }`}
              >
                ໃບຊຳລະເງິນ
              </button>
            </div>
          </div>
        )}

        <div className="max-w-4xl mx-auto w-full">
          {!isViewOnly && activeTab === 'form' ? (
            <div className="w-full">
              <OrderForm 
                items={items} 
                setItems={setItems}
                orderNumber={orderNumber}
                generateNewOrderNumber={generateNewOrderNumber}
              />
            </div>
          ) : (
            <div className="w-full">
              <OrderCard items={items} orderNumber={orderNumber} />
              
              {/* Action Buttons */}
              <div className="flex flex-wrap justify-center gap-4 mt-8 no-print">
                <button
                  onClick={generateShareableLink}
                  className="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg transition-colors"
                >
                  📋 ຄັດລອກລິ້ງ
                </button>
                <button
                  onClick={shareImage}
                  className="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg transition-colors"
                >
                  📤 ແຊຣ์ຮູບ
                </button>
                <button
                  onClick={printCard}
                  className="bg-purple-500 hover:bg-purple-600 text-white px-6 py-2 rounded-lg transition-colors"
                >
                  🖨️ ພິມ
                </button>
              </div>
            </div>
          )}
        </div>

        {/* Modal */}
        {showModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 no-print">
            <div className="bg-white p-6 rounded-lg shadow-xl max-w-sm mx-4">
              <div className="text-center">
                <div className={`w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center ${
                  modalType === 'success' ? 'bg-green-100' : 'bg-red-100'
                }`}>
                  <span className={`text-2xl ${
                    modalType === 'success' ? 'text-green-600' : 'text-red-600'
                  }`}>
                    {modalType === 'success' ? '✓' : '✕'}
                  </span>
                </div>
                <h3 className="text-lg font-semibold mb-2 text-gray-800">
                  {modalType === 'success' ? 'ສຳເລັດ!' : 'ຜິດພາດ!'}
                </h3>
                <p className="text-gray-600 mb-6">{modalMessage}</p>
                <button
                  onClick={() => setShowModal(false)}
                  className={`px-6 py-2 rounded-lg text-white transition-colors ${
                    modalType === 'success' 
                      ? 'bg-green-500 hover:bg-green-600' 
                      : 'bg-red-500 hover:bg-red-600'
                  }`}
                >
                  ຕົກລົງ
                </button>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

// ฟังก์ชันแสดง error overlay ถ้าเกิดข้อผิดพลาด
function showRuntimeErrorOverlay(message, stack) {
  try {
    let overlay = document.getElementById('runtime-error-overlay');
    if (!overlay) {
      overlay = document.createElement('div');
      overlay.id = 'runtime-error-overlay';
      overlay.style.position = 'fixed';
      overlay.style.left = '0';
      overlay.style.top = '0';
      overlay.style.width = '100%';
      overlay.style.height = '100%';
      overlay.style.background = 'rgba(0,0,0,0.8)';
      overlay.style.color = 'white';
      overlay.style.zIndex = '99999';
      overlay.style.overflow = 'auto';
      overlay.style.padding = '24px';
      overlay.style.fontFamily = 'monospace';
      document.body.appendChild(overlay);
    }
    overlay.innerText = 'Runtime error:\n' + message + '\n\n' + (stack || '');
  } catch (e) {
    console.error('Could not show runtime overlay', e);
  }
}

window.addEventListener('error', function (ev) {
  showRuntimeErrorOverlay(ev.message || 'Error', ev.error && ev.error.stack ? ev.error.stack : ev.filename + ':' + ev.lineno + ':' + ev.colno);
});
window.addEventListener('unhandledrejection', function (ev) {
  showRuntimeErrorOverlay(ev.reason && ev.reason.message ? ev.reason.message : String(ev.reason), ev.reason && ev.reason.stack ? ev.reason.stack : '');
});

try {
  ReactDOM.render(<App />, document.getElementById('root'));
} catch (err) {
  console.error(err);
  showRuntimeErrorOverlay(err.message || String(err), err.stack || '');
}
</script>
</body>
</html>
